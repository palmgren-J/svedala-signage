<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="1800"> <title>Svedala Live - Skåne Only</title>
    <style>
        :root {
            --orange: #ffb400; 
            --purple: #5a2d81;
            --yellow: #f9d400;
            --red: #ff4444;
        }
        body { 
            background: #000; 
            color: #fff; 
            font-family: 'Segoe UI', Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            height: 100vh; 
            overflow: hidden; 
        }
        .header { 
            border-bottom: 3px solid var(--yellow); 
            padding-bottom: 10px; 
            margin-bottom: 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        .clock { font-size: 2.8rem; font-weight: bold; }
        h2 { 
            color: var(--yellow); 
            text-transform: uppercase; 
            margin: 25px 0 10px 0; 
            border-left: 6px solid var(--yellow); 
            padding-left: 12px; 
            font-size: 1.4rem;
        }
        .row { 
            display: flex; 
            align-items: center; 
            background: #1a1a1a; 
            margin-bottom: 8px; 
            padding: 15px; 
            border-radius: 8px; 
        }
        .train-row { border-left: 10px solid var(--purple); }
        .bus-row { border-left: 10px solid var(--orange); }
        
        .badge { 
            font-size: 1.6rem; 
            font-weight: bold; 
            padding: 6px 12px; 
            border-radius: 5px; 
            min-width: 65px; 
            text-align: center; 
            margin-right: 20px; 
        }
        .train-badge { background: var(--purple); color: #fff; }
        .bus-badge { background: var(--orange); color: #000; }
        
        .dest { font-size: 1.8rem; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .time { font-size: 2.2rem; color: var(--yellow); font-weight: bold; min-width: 110px; text-align: right; }
        .status { font-size: 0.8rem; color: #444; text-align: center; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="header">
        <h1 style="font-size: 1.6rem; color: #888; margin:0;">SVEDALA LIVE</h1>
        <div id="clock" class="clock">00:00</div>
    </div>

    <h2>Pågatåg (Stationen)</h2>
    <div id="train-board">Söker tåg...</div>

    <h2>Bussar (Stortorget)</h2>
    <div id="bus-board">Söker bussar...</div>

    <div id="debug" class="status">Systemet är aktivt</div>

    <script>
        const apiKey = '029d3e62-8c57-4161-a699-e81a51c12931';

        async function update() {
            const now = new Date();
            document.getElementById('clock').innerText = now.toLocaleTimeString('sv-SE', {hour:'2-digit', minute:'2-digit'});
            
            try {
                // Hämta båda i ett anrop för att spara på API-kvoten
                const [tRes, bRes] = await Promise.all([
                    fetch(`https://api.resrobot.se/v2.1/departureBoard?id=740000158&format=json&accessId=${apiKey}&duration=120`),
                    fetch(`https://api.resrobot.se/v2.1/departureBoard?id=740068571&format=json&accessId=${apiKey}&duration=120`)
                ]);

                const tData = await tRes.json();
                const bData = await bRes.json();

                render(tData.Departure, 'train-board', 'train');
                render(bData.Departure, 'bus-board', 'bus');
                document.getElementById('debug').innerText = "Uppdaterat: " + now.toLocaleTimeString();

            } catch (e) {
                document.getElementById('debug').innerText = "Anslutningsfel - försök pågår...";
            }
        }

        function render(deps, boardId, type) {
            let html = '';
            if (deps && deps.length > 0) {
                const filtered = deps.filter(d => {
                    const line = (d.ProductAtStop ? d.ProductAtStop.displayNumber : d.transportNumber) || '';
                    const dest = (d.direction || '').toLowerCase();
                    const name = (d.name || '').toLowerCase();

                    // TÅGFILTER: Endast Pågatåg, och ALDRIG Mora/Dalarna
                    if (type === 'train') {
                        const isPagatag = name.includes('pågatåg') || d.ProductAtStop.catOutL === "JLT";
                        const isNotDalarna = !dest.includes('mora') && !dest.includes('falun') && !dest.includes('gävle');
                        return isPagatag && isNotDalarna;
                    }

                    // BUSSFILTER: Endast dina specifika linjer och riktningar
                    if (type === 'bus') {
                        if (line === '141' && dest.includes('malmö')) return true;
                        if (line === '145' && dest.includes('trelleborg')) return true;
                        if (line === '165') return true;
                        return false;
                    }
                    return false;
                });

                filtered.slice(0, 5).forEach(d => {
                    const line = (d.ProductAtStop ? d.ProductAtStop.displayNumber : d.transportNumber);
                    const time = (d.rtTime || d.time).substring(0, 5);
                    const cleanDest = d.direction.split(',')[0].replace('Svedala', '').trim();

                    html += `
                        <div class="row ${type === 'bus' ? 'bus-row' : 'train-row'}">
                            <div class="badge ${type === 'bus' ? 'bus-badge' : 'train-badge'}">${line}</div>
                            <div class="dest">${cleanDest}</div>
                            <div class="time">${time}</div>
                        </div>`;
                });
            }
            document.getElementById(boardId).innerHTML = html || '<div style="color:#444; padding:15px;">Inga avgångar hittades</div>';
        }

        setInterval(update, 45000);
        update();
    </script>
</body>
</html>
