<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Svedala Live - Legacy Support</title>
    <style>
        body { background-color: #000; color: #fff; font-family: Arial, sans-serif; margin: 0; padding: 15px; }
        .header { border-bottom: 2px solid #f9d400; padding-bottom: 5px; margin-bottom: 10px; overflow: hidden; }
        .clock { float: right; font-size: 2rem; font-weight: bold; }
        h2 { color: #f9d400; text-transform: uppercase; font-size: 1.1rem; border-left: 4px solid #f9d400; padding-left: 10px; margin: 15px 0 10px 0; }
        .row { display: block; background: #111; margin-bottom: 5px; padding: 10px; border-radius: 4px; overflow: hidden; }
        .train-row { border-left: 8px solid #5a2d81; }
        .bus-row { border-left: 8px solid #ffb400; }
        .badge { float: left; font-weight: bold; padding: 4px 8px; border-radius: 3px; min-width: 45px; text-align: center; margin-right: 12px; }
        .train-badge { background-color: #5a2d81; color: #fff; }
        .bus-badge { background-color: #ffb400; color: #000; }
        .dest { float: left; font-size: 1.2rem; max-width: 60%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .time { float: right; font-size: 1.3rem; color: #f9d400; font-weight: bold; }
        .status { clear: both; font-size: 0.7rem; color: #333; text-align: center; padding-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <div id="clock" class="clock">00:00</div>
        <h1 style="font-size: 1.2rem; color: #888; margin: 10px 0;">SVEDALA LIVE</h1>
    </div>

    <div id="train-section">
        <h2>Pågatåg</h2>
        <div id="train-board">Hämtar tåg...</div>
    </div>

    <div id="bus-section">
        <h2>Bussar (141, 145, 165)</h2>
        <div id="bus-board">Hämtar bussar...</div>
    </div>

    <div class="status" id="debug">Systemet startar...</div>

    <script type="text/javascript">
        // Vi använder 'var' och vanliga 'functions' för att din Samsung ska förstå
        var apiKey = '029d3e62-8c57-4161-a699-e81a51c12931';

        function update() {
            // Uppdatera klockan
            var now = new Date();
            var hh = now.getHours() < 10 ? '0' + now.getHours() : now.getHours();
            var mm = now.getMinutes() < 10 ? '0' + now.getMinutes() : now.getMinutes();
            document.getElementById('clock').innerHTML = hh + ':' + mm;

            // Hämta Tåg (Stationen: 740000158)
            fetchData('740000158', 'train');
            // Hämta Bussar (Stortorget: 740068571)
            fetchData('740068571', 'bus');
        }

        function fetchData(id, type) {
            var url = 'https://api.resrobot.se/v2.1/departureBoard?id=' + id + '&format=json&accessId=' + apiKey + '&duration=120&cb=' + new Date().getTime();
            
            var xhr = new XMLHttpRequest();
            xhr.open('GET', url, true);
            xhr.onreadystatechange = function() {
                if (xhr.readyState == 4 && xhr.status == 200) {
                    var data = JSON.parse(xhr.responseText);
                    render(data.Departure, type);
                }
            };
            xhr.send();
        }

        function render(deps, type) {
            var html = '';
            var boardId = type === 'train' ? 'train-board' : 'bus-board';
            
            if (deps && deps.length > 0) {
                var count = 0;
                for (var i = 0; i < deps.length; i++) {
                    if (count >= 6) break;
                    var d = deps[i];
                    var line = (d.ProductAtStop ? d.ProductAtStop.displayNumber : d.transportNumber) || (type === 'train' ? 'Tåg' : 'Bus');
                    var dest = (d.direction || "Okänd").split(',')[0].replace('Svedala', '').trim();
                    var time = (d.rtTime || d.time || "00:00").substring(0, 5);
                    var destLower = dest.toLowerCase();

                    // Filter
                    var show = false;
                    if (type === 'train') {
                        if (destLower.indexOf("mora") === -1 && destLower.indexOf("falun") === -1) show = true;
                    } else {
                        if (line === "141" && destLower.indexOf("malmö") !== -1) show = true;
                        else if (line === "145" && destLower.indexOf("trelleborg") !== -1) show = true;
                        else if (line === "165") show = true;
                    }

                    if (show) {
                        var rowClass = type === 'train' ? 'train-row' : 'bus-row';
                        var badgeClass = type === 'train' ? 'train-badge' : 'bus-badge';
                        html += '<div class="row ' + rowClass + '">' +
                                '<div class="badge ' + badgeClass + '">' + line + '</div>' +
                                '<div class="dest">' + dest + '</div>' +
                                '<div class="time">' + time + '</div>' +
                                '</div>';
                        count++;
                    }
                }
            }
            
            document.getElementById(boardId).innerHTML = html || '<div style="padding:10px;color:#444;">Inga avgångar hittades</div>';
            document.getElementById('debug').innerHTML = 'Uppdaterat: ' + new Date().toLocaleTimeString();
        }

        // Starta
        update();
        // Uppdatera varje minut
        setInterval(update, 60000);
    </script>
</body>
</html>
