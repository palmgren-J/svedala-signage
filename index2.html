<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Svedala Live - Stabil Version</title>
    <style>
        :root {
            --skane-orange: #ffb400; 
            --skane-purple: #5a2d81;
            --skane-yellow: #f9d400;
            --delay-red: #ff4444;
        }
        body {
            background-color: #000;
            color: white;
            font-family: 'Segoe UI', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            overflow: hidden;
            height: 100vh;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--skane-yellow);
            padding-bottom: 10px;
            margin-bottom: 10px;
        }
        h1 { font-size: 1.4rem; margin: 0; text-transform: uppercase; color: #aaa; }
        .clock { font-size: 2.2rem; font-weight: bold; }

        h2 { 
            font-size: 1.2rem; 
            margin: 15px 0 10px 0; 
            color: var(--skane-yellow); 
            text-transform: uppercase;
            border-left: 5px solid var(--skane-yellow);
            padding-left: 12px;
        }

        .departure-row {
            display: flex;
            align-items: center;
            background: #151515;
            margin-bottom: 6px;
            padding: 12px;
            border-radius: 6px;
        }
        
        .train-row { border-left: 8px solid var(--skane-purple); }
        .bus-row { border-left: 8px solid var(--skane-orange); }

        .line-badge {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 5px 10px;
            border-radius: 4px;
            min-width: 50px;
            text-align: center;
            margin-right: 15px;
        }
        .train-badge { background-color: var(--skane-purple); color: white; }
        .bus-badge { background-color: var(--skane-orange); color: #000; }

        .dest { font-size: 1.4rem; flex-grow: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .time-box { text-align: right; min-width: 100px; }
        .time { font-size: 1.5rem; color: var(--skane-yellow); font-weight: bold; }
        .delay { font-size: 1rem; color: var(--delay-red); font-weight: bold; margin-left: 4px; }
        .status { font-size: 0.8rem; color: #444; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>Svedala Live</h1>
        <div class="clock" id="clock">--:--</div>
    </div>

    <section>
        <h2>Pågatåg</h2>
        <div id="train-board">Hämtar tåg...</div>
    </section>

    <section>
        <h2>Bussar (141, 145, 165)</h2>
        <div id="bus-board">Hämtar bussar...</div>
    </section>

    <div class="status" id="debug">Startar systemet...</div>

    <script>
        var apiKey = '029d3e62-8c57-4161-a699-e81a51c12931';
        var TRAIN_STATION_ID = "740000158"; 
        var BUS_STOP_ID = "740068571";      

        function getDelay(sched, real) {
            if (!real || sched === real) return 0;
            try {
                var s = sched.split(':');
                var r = real.split(':');
                var diff = (parseInt(r[0], 10) * 60 + parseInt(r[1], 10)) - (parseInt(s[0], 10) * 60 + parseInt(s[1], 10));
                return diff > 0 ? diff : 0;
            } catch(e) { return 0; }
        }

        async function updateBoards() {
            var timestamp = new Date().getTime(); // Cache-buster
            try {
                // Hämta Tåg
                var tRes = await fetch('https://api.resrobot.se/v2.1/departureBoard?id=' + TRAIN_STATION_ID + '&format=json&accessId=' + apiKey + '&duration=120&cb=' + timestamp);
                var tData = await tRes.json();
                renderTrains(tData);

                // Hämta Bussar
                var bRes = await fetch('https://api.resrobot.se/v2.1/departureBoard?id=' + BUS_STOP_ID + '&format=json&accessId=' + apiKey + '&duration=120&cb=' + timestamp);
                var bData = await bRes.json();
                renderBuses(bData);

                document.getElementById('debug').innerText = "Uppdaterat: " + new Date().toLocaleTimeString('sv-SE');
            } catch (err) {
                document.getElementById('debug').innerText = "Kunde inte uppdatera - behåller tidigare tider.";
            }
        }

        function renderTrains(data) {
            var html = '';
            if (data && data.Departure) {
                var trains = data.Departure.filter(function(d) {
                    var name = (d.name || "").toLowerCase();
                    var dest = (d.direction || "").toLowerCase();
                    return (name.indexOf('tåg') !== -1 || (d.ProductAtStop && d.ProductAtStop.catOutL === "JLT")) && dest.indexOf("mora") === -1;
                });
                for (var i = 0; i < Math.min(trains.length, 5); i++) {
                    html += createRowHtml(trains[i], 'train');
                }
            }
            if (html !== '') document.getElementById('train-board').innerHTML = html;
        }

        function renderBuses(data) {
            var html = '';
            if (data && data.Departure) {
                var buses = data.Departure.filter(function(d) {
                    var line = d.ProductAtStop ? d.ProductAtStop.displayNumber : d.transportNumber;
                    var dest = (d.direction || "").toLowerCase();
                    if (line === "141" && dest.indexOf("malmö") !== -1) return true;
                    if (line === "145" && dest.indexOf("trelleborg") !== -1) return true;
                    if (line === "165") return true;
                    return false;
                });
                for (var i = 0; i < Math.min(buses.length, 7); i++) {
                    html += createRowHtml(buses[i], 'bus');
                }
            }
            if (html !== '') document.getElementById('bus-board').innerHTML = html;
        }

        function createRowHtml(dep, type) {
            var line = dep.ProductAtStop ? dep.ProductAtStop.displayNumber : dep.transportNumber;
            var dest = dep.direction.split(',')[0].replace('Svedala', '').trim();
            var schedTime = (dep.time || "00:00").substring(0, 5);
            var realTime = (dep.rtTime || dep.time || "00:00").substring(0, 5);
            var delay = getDelay(schedTime, realTime);
            
            var badgeColor = type === 'train' ? 'train-badge' : 'bus-badge';
            var rowType = type === 'train' ? 'train-row' : 'bus-row';

            return '<div class="departure-row ' + rowType + '">' +
                   '<div class="line-badge ' + badgeColor + '">' + line + '</div>' +
                   '<div class="dest">' + dest + '</div>' +
                   '<div class="time-box">' +
                   '<span class="time">' + realTime + '</span>' +
